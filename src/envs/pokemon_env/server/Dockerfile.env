# Dockerfile for Pokemon Battle Environment OpenEnv
# This image provides Pokemon battles via poke-env

# Build OpenEnv base (can be overridden for CI/CD)
ARG BASE_IMAGE
FROM ${BASE_IMAGE:-openenv-base:latest} AS final

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    supervisor \
    && rm -rf /var/lib/apt/lists/*

# Install poke-env and dependencies
RUN pip install --no-cache-dir \
    poke-env>=0.9.0 \
    gymnasium>=0.29.0

# Copy OpenEnv core (base image already set WORKDIR=/app)
COPY src/core/ /app/src/core/

# Copy Pokemon environment code
COPY src/envs/pokemon_env/ /app/src/envs/pokemon_env/

# Copy README for web interface documentation
COPY src/envs/pokemon_env/README.md /app/README.md

# Pokemon environment variables
ENV POKEMON_BATTLE_FORMAT=gen9randombattle
ENV POKEMON_PLAYER_USERNAME=player
ENV POKEMON_REWARD_MODE=sparse
ENV POKEMON_MAX_TURNS=1000

# Expose OpenEnv port
EXPOSE 9980

# Create supervisor config for OpenEnv
RUN echo '[supervisord]\n\
nodaemon=true\n\
logfile=/dev/null\n\
logfile_maxbytes=0\n\
\n\
[program:openenv]\n\
command=uvicorn envs.pokemon_env.server.app:app --host 0.0.0.0 --port 9980\n\
directory=/app\n\
environment=PYTHONPATH="/app/src"\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/dev/fd/1\n\
stdout_logfile_maxbytes=0\n\
stderr_logfile=/dev/fd/2\n\
stderr_logfile_maxbytes=0\n\
startsecs=10\n' > /etc/supervisor/conf.d/pokemon-env.conf

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:9980/health || exit 1

# Run supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]